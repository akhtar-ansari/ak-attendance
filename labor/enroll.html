<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AK Attendance - Face Enrollment</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .enroll-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
        }
        .labor-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        .labor-info h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .labor-info p {
            opacity: 0.9;
            font-size: 14px;
        }
        .camera-section {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 25px;
        }
        #video {
            width: 100%;
            display: block;
            transform: scaleX(-1);
        }
        #canvas {
            display: none;
        }
        .face-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 320px;
            border: 4px solid #48bb78;
            border-radius: 150px;
            box-shadow: 0 0 30px rgba(72, 187, 120, 0.5);
            pointer-events: none;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .status-bar {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }
        .status-bar.loading { background: #bee3f8; color: #2c5282; }
        .status-bar.ready { background: #c6f6d5; color: #22543d; }
        .status-bar.error { background: #fed7d7; color: #c53030; }
        .status-bar.processing { background: #fefcbf; color: #975a16; }
        .enroll-btn {
            width: 100%;
            padding: 18px;
            font-size: 18px;
            border-radius: 10px;
        }
        .instructions {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
        }
        .instructions h4 {
            color: #667eea;
            margin-bottom: 12px;
        }
        .instructions ul {
            margin-left: 20px;
            line-height: 1.8;
            color: #555;
        }
        .already-enrolled {
            background: #fefcbf;
            border: 1px solid #ecc94b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #975a16;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ Face Enrollment</h1>
            <div class="header-actions">
                <button type="button" class="btn btn-secondary" onclick="location.href='master.html'">‚Üê Labor Master</button>
            </div>
        </div>

        <div class="enroll-container">
            <!-- Labor Info -->
            <div class="labor-info" id="laborInfo">
                <h2 id="laborName">Loading...</h2>
                <p id="laborDetails">Please wait...</p>
            </div>

            <!-- Already Enrolled Warning -->
            <div class="already-enrolled" id="alreadyEnrolled" style="display: none;">
                ‚ö†Ô∏è Face is already enrolled for this laborer. Proceeding will replace the existing enrollment.
            </div>

            <!-- Status Bar -->
            <div class="status-bar loading" id="statusBar">
                ‚è≥ Initializing...
            </div>

            <!-- Camera Section -->
            <div class="camera-section">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
                <div class="face-guide" id="faceGuide"></div>
            </div>

            <!-- Enroll Button -->
            <button type="button" class="btn btn-success enroll-btn" id="enrollBtn" onclick="captureAndEnroll()" disabled>
                üì∏ Capture & Enroll Face
            </button>

            <!-- Instructions -->
            <div class="instructions">
                <h4>üìã Instructions</h4>
                <ul>
                    <li>Position face inside the oval guide</li>
                    <li>Ensure good lighting (avoid shadows on face)</li>
                    <li>Look directly at the camera</li>
                    <li>Remove glasses if possible</li>
                    <li>Keep a neutral expression</li>
                    <li>Hold still and click "Capture & Enroll"</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- App Scripts -->
    <script src="../js/config/supabase.js"></script>
    <script src="../js/auth/auth.js"></script>
    <script src="../js/utils/date-utils.js"></script>
    <script src="../js/ui/sync-indicator.js"></script>
    <script src="../js/ui/toast.js"></script>
    <script src="../js/api/labor-api.js"></script>

    <script>
        // Require login
        if (!AUTH.requireLogin()) {
            window.location.href = '../index.html';
        }

        // Get labor ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const laborId = urlParams.get('id');

        if (!laborId) {
            alert('No Labor ID provided!');
            location.href = 'master.html';
        }

        let modelsLoaded = false;
        let stream = null;
        let currentLabor = null;

        // Initialize
        async function init() {
            try {
                updateStatus('loading', '‚è≥ Loading labor data...');
                
                // Load labor data
                const result = await LaborAPI.getByLaborId(laborId);
                if (!result.success || !result.data) {
                    throw new Error('Labor not found');
                }

                currentLabor = result.data;
                
                // Display labor info
                document.getElementById('laborName').textContent = currentLabor.name;
                document.getElementById('laborDetails').textContent = 
                    `${currentLabor.labor_id} | ${currentLabor.iqama_number} | ${currentLabor.nationality}`;

                // Check if already enrolled
                if (currentLabor.face_enrolled) {
                    document.getElementById('alreadyEnrolled').style.display = 'block';
                }

                // Load face-api models
                updateStatus('loading', '‚è≥ Loading AI models...');
                await loadModels();

                // Start camera
                updateStatus('loading', '‚è≥ Starting camera...');
                await startCamera();

                // Ready
                updateStatus('ready', '‚úÖ Ready! Position your face and click Capture.');
                document.getElementById('enrollBtn').disabled = false;

            } catch (error) {
                console.error('Init error:', error);
                updateStatus('error', '‚ùå Error: ' + error.message);
            }
        }

        // Update status bar
        function updateStatus(type, message) {
            const statusBar = document.getElementById('statusBar');
            statusBar.className = 'status-bar ' + type;
            statusBar.textContent = message;
        }

        // Load face-api models
        async function loadModels() {
            try {
                const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models/';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                modelsLoaded = true;
                console.log('‚úÖ Face-API models loaded');
            } catch (error) {
                console.error('Model loading error:', error);
                throw new Error('Failed to load AI models. Check internet connection.');
            }
        }

        // Start camera
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    }
                });
                document.getElementById('video').srcObject = stream;
                console.log('‚úÖ Camera started');
            } catch (error) {
                console.error('Camera error:', error);
                throw new Error('Camera access denied. Please allow camera permission.');
            }
        }

        // Capture and enroll
        async function captureAndEnroll() {
            if (!modelsLoaded) {
                Toast.error('AI models not loaded yet!');
                return;
            }

            const enrollBtn = document.getElementById('enrollBtn');
            enrollBtn.disabled = true;
            updateStatus('processing', 'üîç Detecting face...');

            try {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                
                // Set canvas size
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // Draw mirrored image
                const ctx = canvas.getContext('2d');
                ctx.scale(-1, 1);
                ctx.drawImage(video, -canvas.width, 0);
                ctx.setTransform(1, 0, 0, 1, 0, 0);

                // Detect face
                updateStatus('processing', 'üîç Analyzing face...');
                
                const detection = await faceapi
                    .detectSingleFace(canvas, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor();

                if (!detection) {
                    throw new Error('No face detected! Position your face in the oval and try again.');
                }

                // Check face confidence
                const faceScore = detection.detection.score;
                console.log('Face detection score:', faceScore);

                if (faceScore < 0.7) {
                    throw new Error('Face not clear enough. Please improve lighting and try again.');
                }

                // Save face descriptor
                updateStatus('processing', 'üíæ Saving to cloud...');
                
                const faceDescriptor = Array.from(detection.descriptor);
                
                const saveResult = await LaborAPI.updateFaceEnrollment(laborId, faceDescriptor);

                if (!saveResult.success) {
                    throw new Error(saveResult.error || 'Failed to save enrollment');
                }

                // Success
                updateStatus('ready', '‚úÖ Face enrolled successfully!');
                Toast.success('Face enrollment complete!');

                // Redirect after 2 seconds
                setTimeout(() => {
                    location.href = 'master.html';
                }, 2000);

            } catch (error) {
                console.error('Enrollment error:', error);
                updateStatus('error', '‚ùå ' + error.message);
                Toast.error(error.message);
                enrollBtn.disabled = false;
            }
        }

        // Cleanup on page leave
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // Start initialization
        init();
    </script>
</body>
</html>