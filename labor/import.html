<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AK Attendance - Import Laborers</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .upload-area {
            border: 3px dashed #e0e0e0;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .upload-area .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        .upload-area h3 {
            color: #333;
            margin-bottom: 10px;
        }
        .upload-area p {
            color: #666;
            font-size: 14px;
        }
        .preview-section {
            margin-top: 30px;
            display: none;
        }
        .preview-section.active {
            display: block;
        }
        .preview-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .preview-stat {
            padding: 15px 25px;
            border-radius: 8px;
            text-align: center;
        }
        .preview-stat.valid { background: #c6f6d5; color: #22543d; }
        .preview-stat.invalid { background: #fed7d7; color: #c53030; }
        .preview-stat.total { background: #e2e8f0; color: #4a5568; }
        .preview-stat .number { font-size: 28px; font-weight: bold; }
        .preview-stat .label { font-size: 12px; }
        .error-list {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .error-list h4 {
            color: #c53030;
            margin-bottom: 10px;
        }
        .error-list ul {
            margin-left: 20px;
            color: #742a2a;
            font-size: 14px;
        }
        .preview-table {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .preview-table table {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì§ Import Laborers</h1>
            <div class="header-actions">
                <button type="button" class="btn btn-secondary" onclick="location.href='master.html'">‚Üê Labor Master</button>
            </div>
        </div>

        <div class="content">
            <!-- Instructions -->
            <div class="card mb-20">
                <div class="card-body">
                    <h3 style="margin-bottom: 15px;">üìã Instructions</h3>
                    <ol style="line-height: 2; color: #555; margin-left: 20px;">
                        <li>Download the CSV template below</li>
                        <li>Fill in laborer details (do not change column headers)</li>
                        <li>Save as CSV file</li>
                        <li>Upload the file here</li>
                        <li>Review and confirm import</li>
                    </ol>
                    <div style="margin-top: 20px;">
                        <button type="button" class="btn btn-primary" onclick="downloadTemplate()">üì• Download Template</button>
                    </div>
                </div>
            </div>

            <!-- Upload Area -->
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="icon">üìÅ</div>
                <h3>Click to Upload CSV File</h3>
                <p>or drag and drop file here</p>
                <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
            </div>

            <!-- Preview Section -->
            <div class="preview-section" id="previewSection">
                <h3 style="margin-bottom: 20px;">üìä Import Preview</h3>
                
                <div class="preview-stats">
                    <div class="preview-stat total">
                        <div class="number" id="totalRows">0</div>
                        <div class="label">Total Rows</div>
                    </div>
                    <div class="preview-stat valid">
                        <div class="number" id="validRows">0</div>
                        <div class="label">Valid</div>
                    </div>
                    <div class="preview-stat invalid">
                        <div class="number" id="invalidRows">0</div>
                        <div class="label">Errors</div>
                    </div>
                </div>

                <!-- Error List -->
                <div class="error-list" id="errorList" style="display: none;">
                    <h4>‚ö†Ô∏è Errors Found</h4>
                    <ul id="errorListItems"></ul>
                </div>

                <!-- Preview Table -->
                <div class="preview-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Iqama</th>
                                <th>Name</th>
                                <th>Nationality</th>
                                <th>DOJ</th>
                                <th>Department</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="previewTable"></tbody>
                    </table>
                </div>

                <!-- Import Button -->
                <div style="margin-top: 20px; display: flex; gap: 15px;">
                    <button type="button" class="btn btn-success btn-lg" id="importBtn" onclick="startImport()">
                        ‚úÖ Import Valid Records
                    </button>
                    <button type="button" class="btn btn-secondary btn-lg" onclick="resetUpload()">
                        üîÑ Upload Different File
                    </button>
                </div>
            </div>

            <!-- Import Results -->
            <div class="preview-section" id="resultsSection">
                <div class="card">
                    <div class="card-body text-center" id="resultsContent">
                        <!-- Results will be shown here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- App Scripts -->
    <script src="../js/config/supabase.js"></script>
    <script src="../js/auth/auth.js"></script>
    <script src="../js/utils/date-utils.js"></script>
    <script src="../js/utils/csv-handler.js"></script>
    <script src="../js/ui/sync-indicator.js"></script>
    <script src="../js/ui/toast.js"></script>
    <script src="../js/api/department-api.js"></script>
    <script src="../js/api/labor-api.js"></script>

    <script>
        // Require admin role
        if (!AUTH.requireRole(['super_admin', 'admin'])) {
            window.location.href = '../dashboard.html';
        }

        let parsedData = null;
        let departments = [];
        let departmentMap = {};

        // Load departments
        async function loadDepartments() {
            try {
                SyncIndicator.show('Loading departments...');
                const result = await DepartmentAPI.getActive();
                if (result.success) {
                    departments = result.data;
                    departmentMap = {};
                    departments.forEach(d => {
                        departmentMap[d.code.toUpperCase()] = d.id;
                    });
                }
                SyncIndicator.hide();
            } catch (error) {
                SyncIndicator.hide();
                Toast.error('Failed to load departments');
            }
        }

        // Download template
        function downloadTemplate() {
            CSVHandler.downloadTemplate();
            Toast.success('Template downloaded!');
        }

        // Handle file select
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.csv')) {
                Toast.error('Please upload a CSV file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                processCSV(e.target.result);
            };
            reader.readAsText(file);
        }

        // Process CSV
        function processCSV(csvText) {
            const result = CSVHandler.parse(csvText);

            if (!result.success) {
                Toast.error(result.error);
                return;
            }

            // Validate department codes
            result.data.forEach(row => {
                if (!departmentMap[row.departmentCode]) {
                    result.errors.push({
                        row: 'N/A',
                        errors: [`Unknown department code: ${row.departmentCode}`]
                    });
                    result.errorRows++;
                    result.validRows--;
                } else {
                    row.departmentId = departmentMap[row.departmentCode];
                }
            });

            // Filter valid data
            parsedData = result.data.filter(row => row.departmentId);

            // Update UI
            document.getElementById('totalRows').textContent = result.totalRows;
            document.getElementById('validRows').textContent = parsedData.length;
            document.getElementById('invalidRows').textContent = result.errors.length;

            // Show errors if any
            if (result.errors.length > 0) {
                document.getElementById('errorList').style.display = 'block';
                document.getElementById('errorListItems').innerHTML = result.errors.map(e => 
                    `<li>Row ${e.row}: ${e.errors.join(', ')}</li>`
                ).join('');
            } else {
                document.getElementById('errorList').style.display = 'none';
            }

            // Render preview table
            document.getElementById('previewTable').innerHTML = parsedData.map(row => `
                <tr>
                    <td>${row.iqamaNumber}</td>
                    <td>${row.name}</td>
                    <td>${row.nationality}</td>
                    <td>${DateUtils.formatDate(row.dateOfJoining)}</td>
                    <td>${row.departmentCode}</td>
                    <td>${row.status}</td>
                </tr>
            `).join('');

            // Enable/disable import button
            document.getElementById('importBtn').disabled = parsedData.length === 0;

            // Show preview section
            document.getElementById('previewSection').classList.add('active');
            document.getElementById('resultsSection').classList.remove('active');
        }

        // Reset upload
        function resetUpload() {
            parsedData = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('previewSection').classList.remove('active');
            document.getElementById('resultsSection').classList.remove('active');
        }

        // Start import
        async function startImport() {
            if (!parsedData || parsedData.length === 0) {
                Toast.error('No valid data to import');
                return;
            }

            if (!confirm(`Import ${parsedData.length} laborers?\n\nDuplicates (same Iqama) will be skipped.`)) {
                return;
            }

            try {
                SyncIndicator.show('Importing laborers...');

                const results = await LaborAPI.bulkImport(parsedData);

                SyncIndicator.hide();

                // Show results
                document.getElementById('previewSection').classList.remove('active');
                document.getElementById('resultsSection').classList.add('active');

                let resultsHtml = `
                    <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
                    <h2 style="color: #48bb78; margin-bottom: 20px;">Import Complete!</h2>
                    <div class="preview-stats" style="justify-content: center;">
                        <div class="preview-stat valid">
                            <div class="number">${results.success}</div>
                            <div class="label">Imported</div>
                        </div>
                        <div class="preview-stat invalid">
                            <div class="number">${results.failed}</div>
                            <div class="label">Failed</div>
                        </div>
                    </div>
                `;

                if (results.errors.length > 0) {
                    resultsHtml += `
                        <div class="error-list" style="text-align: left; margin-top: 20px;">
                            <h4>‚ö†Ô∏è Failed Records</h4>
                            <ul>
                                ${results.errors.map(e => `<li>Iqama ${e.iqama}: ${e.error}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                resultsHtml += `
                    <div style="margin-top: 30px;">
                        <button class="btn btn-primary" onclick="location.href='master.html'">üë• Go to Labor Master</button>
                        <button class="btn btn-secondary" onclick="resetUpload()">üì§ Import More</button>
                    </div>
                `;

                document.getElementById('resultsContent').innerHTML = resultsHtml;

            } catch (error) {
                SyncIndicator.hide();
                Toast.error('Import failed: ' + error.message);
            }
        }

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                const reader = new FileReader();
                reader.onload = (e) => processCSV(e.target.result);
                reader.readAsText(file);
            } else {
                Toast.error('Please upload a CSV file');
            }
        });

        // Initialize
        loadDepartments();
    </script>
</body>
</html>